name: CI-Multi-Service-Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  OPENSHIFT_SERVER_URL: https://api.rm2.thpm.p1.openshiftapps.com:6443
  OPENSHIFT_PROJECT: k-att-y70-dev
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  # ============================================
  # BUILD FRONTEND
  # ============================================
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Frontend
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_USERNAME }}/frontend
          tags: |
            type=raw,value=build-${{ github.run_number }}

      - name: Build & Push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend-chart
          file: ./frontend-chart/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ============================================
  # BUILD BACKEND-API
  # ============================================
  # build-backend-api:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Log in to Docker Hub
  #       uses: docker/login-action@v3
  #       with:
  #         username: ${{ secrets.DOCKER_USERNAME }}
  #         password: ${{ secrets.DOCKERHUB_TOKEN }}
  #
  #     - name: Extract metadata for Backend-API
  #       id: meta
  #       uses: docker/metadata-action@v5
  #       with:
  #         images: ${{ env.DOCKER_USERNAME }}/backend-api
  #         tags: |
  #           type=raw,value=build-${{ github.run_number }}
  #
  #     - name: Build & Push Backend-API image
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: ./backend-api-chart
  #         file: ./backend-api-chart/Dockerfile
  #         push: true
  #         tags: ${{ steps.meta.outputs.tags }}
  #         labels: ${{ steps.meta.outputs.labels }}

  # ============================================
  # BUILD BACKEND-DATA
  # ============================================
  # build-backend-data:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Log in to Docker Hub
  #       uses: docker/login-action@v3
  #       with:
  #         username: ${{ secrets.DOCKER_USERNAME }}
  #         password: ${{ secrets.DOCKERHUB_TOKEN }}
  #
  #     - name: Extract metadata for Backend-Data
  #       id: meta
  #       uses: docker/metadata-action@v5
  #       with:
  #         images: ${{ env.DOCKER_USERNAME }}/backend-data
  #         tags: |
  #           type=raw,value=build-${{ github.run_number }}
  #
  #     - name: Build & Push Backend-Data image
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: ./backend-data-chart
  #         file: ./backend-data-chart/Dockerfile
  #         push: true
  #         tags: ${{ steps.meta.outputs.tags }}
  #         labels: ${{ steps.meta.outputs.labels }}

  # ============================================
  # DEPLOY ALL SERVICES
  # ============================================
  deploy:
    needs: [build-frontend, build-backend-api, build-backend-data]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OC & Helm
        run: |
          curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz | tar xz
          sudo mv oc /usr/local/bin/ && oc version
          curl -L https://get.helm.sh/helm-v3.15.4-linux-amd64.tar.gz | tar xz
          sudo mv linux-amd64/helm /usr/local/bin/ && helm version

      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ env.OPENSHIFT_SERVER_URL }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}

      - name: Select OpenShift project
        run: oc project ${{ env.OPENSHIFT_PROJECT }}

      # ============================================
      # DEPLOY BACKEND-DATA (primero, necesita conectarse a DB)
      # ============================================
      #- name: Helm Lint - Backend-Data
      #  run: helm lint ./backend-data-chart

      #- name: Deploy Backend-Data
       # run: |
        #  helm upgrade --install backend-data ./backend-data-chart \
         #   -n ${{ env.OPENSHIFT_PROJECT }} \
          #  --set namespace=${{ env.OPENSHIFT_PROJECT }} \
           # --set image.repository=${{ env.DOCKER_USERNAME }}/backend-data \
            #--set image.tag=build-${{ github.run_number }}

      #- name: Wait for Backend-Data rollout
       # run: oc rollout status deployment/backend-data-deployment -n ${{ env.OPENSHIFT_PROJECT }} --timeout=5m

      # ============================================
      # DEPLOY BACKEND-API (segundo, depende de backend-data)
      # ============================================
      #- name: Helm Lint - Backend-API
       # run: helm lint ./backend-api-chart

      #- name: Deploy Backend-API
       # run: |
        #  helm upgrade --install backend-api ./backend-api-chart \
         #   -n ${{ env.OPENSHIFT_PROJECT }} \
          #  --set namespace=${{ env.OPENSHIFT_PROJECT }} \
           # --set image.repository=${{ env.DOCKER_USERNAME }}/backend-api \
            #--set image.tag=build-${{ github.run_number }}

      #- name: Wait for Backend-API rollout
       # run: oc rollout status deployment/backend-api-deployment -n ${{ env.OPENSHIFT_PROJECT }} --timeout=5m

      # ============================================
      # DEPLOY FRONTEND (Ãºltimo, depende de backend-api)
      # ============================================
      - name: Helm Lint - Frontend
        run: helm lint ./frontend-chart

      - name: Deploy Frontend
        run: |
          helm upgrade --install frontend ./frontend-chart \
            -n ${{ env.OPENSHIFT_PROJECT }} \
            --set namespace=${{ env.OPENSHIFT_PROJECT }} \
            --set image.repository=${{ env.DOCKER_USERNAME }}/frontend \
            --set image.tag=build-${{ github.run_number }}

      - name: Wait for Frontend rollout
        run: oc rollout status deployment/frontend-deployment -n ${{ env.OPENSHIFT_PROJECT }} --timeout=5m

      # ============================================
      # SHOW DEPLOYED RESOURCES
      # ============================================
      - name: Show all deployed resources
        run: |
          echo "=========================================="
          echo "DEPLOYMENTS, SERVICES, CONFIGMAPS, SECRETS"
          echo "=========================================="
          oc get deploy,svc,cm,secret,hpa -n ${{ env.OPENSHIFT_PROJECT }} -o wide
          echo ""
          echo "=========================================="
          echo "PODS"
          echo "=========================================="
          oc get pods -n ${{ env.OPENSHIFT_PROJECT }} -o wide
          echo ""
          echo "=========================================="
          echo "ROUTES (if any)"
          echo "=========================================="
          oc get routes -n ${{ env.OPENSHIFT_PROJECT }} -o wide || echo "No routes found"